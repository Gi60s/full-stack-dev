
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Full Stack Web Development | Session Management</title>
  

  <link rel="icon" href="/full-stack-dev/favicon.png">

  <link rel="stylesheet" href="/full-stack-dev/template-files/styles/main.css" media="all">
  
  
  <link rel="stylesheet" href="/full-stack-dev/css/main.css" media="all">
  
  
  
</head>

<body>
  <header class="site-header">
    <div class="wrapper">
      <a class="site-title" href="/full-stack-dev">
        Full Stack Web Development
      </a>

      
      <nav class="site-nav">
        <a href="#" class="menu-icon" aria-label="Menu">
          <svg viewBox="0 0 18 15">
            <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
            <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
            <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
          </svg>
        </a>
      </nav>
      
    </div>
  </header>

<div class="page-content">
  <div class="wrapper">

    
    <div class="nav-screen"></div>
    <nav class="nav-list"><ul><li><a href="/full-stack-dev">Home</a></li><li><a href="/full-stack-dev/history">History of the Web</a></li><li><a href="/full-stack-dev/domain-driven-design">Domain Driven Design</a></li><li><a href="/full-stack-dev/git">Git</a></li><li><a href="/full-stack-dev/rest">REST</a></li><li><a href="/full-stack-dev/javascript">JavaScript Fundamentals</a></li><li><a href="/full-stack-dev/node-and-npm">NodeJS and NPM</a></li><li><a href="/full-stack-dev/express">Express</a></li><li><a href="/full-stack-dev/testing-intro">Testing Introduction</a></li><li><a href="/full-stack-dev/testing-nodejs">Testing NodeJS</a></li><li><a href="/full-stack-dev/async-javascript">Asynchronous JavaScript</a></li><li><a href="/full-stack-dev/events">Events</a></li><li><a href="/full-stack-dev/docker-part-1">Docker (Part 1)</a></li><li><a href="/full-stack-dev/docker-part-2">Docker (Part 2)</a></li><li><a href="/full-stack-dev/sql">SQL Databases</a></li><li><a href="/full-stack-dev/nosql">NoSQL Databases</a></li><li><a href="/full-stack-dev/session-management" class="current-page">Session Management</a></li><li><a href="/full-stack-dev/html-css">HTML and CSS</a></li><li><a href="/full-stack-dev/browser-events">Browser Events</a></li><li><a href="/full-stack-dev/vue">Vue Introduction</a></li><li><a href="/full-stack-dev/vue-cli">Vue CLI</a></li><li><a href="/full-stack-dev/vue-components">Vue Components</a></li><li><a href="/full-stack-dev/vue-router">Vue Router</a></li><li><a href="/full-stack-dev/vuex">Vuex</a></li><li><a href="/full-stack-dev/nuxt">Nuxt</a></li><li><a href="/full-stack-dev/css-pre-processors">CSS Pre-Processors</a></li><li><a href="/full-stack-dev/signup">Sign-up Queue</a></li></ul></li></nav>
    

    <div class="page-content-main">
      <article class="post">
        <header class="post-header">
          
          <h1 class="post-title">Session Management</h1>
        </header>

        
        <div>
          <p><strong>Page Content</strong></p>
          <div class="section-nav"><ul class="toc"><li><a href="#cookies">Cookies</a></li><li><a href="#passport-and-express">Passport and Express</a></li></ul></div>
        </div>
        

        <div class="post-content"><h1 id="cookies">Cookies</h1>
<p>From <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies</a>:</p>
<blockquote>
<p>An HTTP cookie (web cookie, browser cookie) is a small piece of data that a server sends to the user&#39;s web browser. The browser may store it and send it back with the next request to the same server. Typically, it&#39;s used to tell if two requests came from the same browser â€” keeping a user logged-in, for example. It remembers stateful information for the stateless HTTP protocol.</p>
</blockquote>
<ol>
<li><p>Server tells the browser to save some <em>small</em> data.</p>
</li>
<li><p>Browser sends that cookie back to the server with each request.</p>
</li>
</ol>
<p>Often used for:</p>
<ul>
<li><p>Session management</p>
</li>
<li><p>Personalization</p>
</li>
<li><p>Tracking</p>
</li>
</ul>
<h2 id="cookie-options">Cookie Options</h2>
<ul>
<li><p>Expiration date - how long should the browser keep the cookie. Follow up visits to the server may renew the cookie.</p>
</li>
<li><p>Domain and path - tells the browser which requests being sent to the server should include the cookie.</p>
</li>
<li><p><a href="https://expressjs.com/en/4x/api.html#res.cookie">Express Cookie Settings</a></p>
</li>
</ul>
<h1 id="passport-and-express">Passport and Express</h1>
<blockquote>
<p>Passport is authentication <em>middleware</em> for Node.js. Extremely flexible and modular, Passport can be unobtrusively dropped in to any Express-based web application.</p>
<p><a href="http://passportjs.org/">http://passportjs.org/</a></p>
</blockquote>
<ul>
<li>It reduces the amount of work you need to do for authentication.</li>
<li>It has the ability to do local authentication.</li>
<li>It has OAuth capabilities (use Facebook, Google, or other services to log in).</li>
<li>It is modular, you need to include the components that you are interested in.</li>
</ul>
<p><a href="http://passportjs.org/docs">Passport Documentation</a></p>
<h2 id="strategies">Strategies</h2>
<p>Using passport you&#39;ll hear about strategies. A strategy:</p>
<ul>
<li>Is a module that integrates with Passport.</li>
<li>Handles a specific type of authentication (local, OAuth, etc).</li>
<li>Must be installed (via npm) independently of the Passport module.</li>
<li>Has its own documentation with instructions for usage.</li>
</ul>
<h2 id="starter-code-example">Starter Code Example</h2>
<pre><code class="language-js"><span class="hljs-comment">// include modules</span>
<span class="hljs-keyword">const</span> cookieParser      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-parser'</span>);
<span class="hljs-keyword">const</span> express           = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> LocalStrategy     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-local'</span>).Strategy;
<span class="hljs-keyword">const</span> passport          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">const</span> session           = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);

<span class="hljs-comment">// initialize express app</span>
<span class="hljs-keyword">const</span> app = express();

<span class="hljs-comment">// tell passport to use a local strategy and tell it how to validate a username and password</span>
passport.use(<span class="hljs-keyword">new</span> LocalStrategy(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">username, password, done</span>) </span>{
    <span class="hljs-keyword">if</span> (username &amp;&amp; password === <span class="hljs-string">'pass'</span>) <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, { <span class="hljs-attr">username</span>: username });
    <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
}));

<span class="hljs-comment">// tell passport how to turn a user into serialized data that will be stored with the session</span>
passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user, done</span>) </span>{
    done(<span class="hljs-literal">null</span>, user.username);
});

<span class="hljs-comment">// tell passport how to go from the serialized data back to the user</span>
passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id, done</span>) </span>{
    done(<span class="hljs-literal">null</span>, { <span class="hljs-attr">username</span>: id });
});

<span class="hljs-comment">// tell the express app what middleware to use</span>
app.use(express.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));
app.use(cookieParser());
app.use(session({ <span class="hljs-attr">secret</span>: <span class="hljs-string">'secret key'</span>, <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">true</span> }));
app.use(passport.initialize());
app.use(passport.session());

<span class="hljs-comment">// home page</span>
app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-keyword">if</span> (req.user) <span class="hljs-keyword">return</span> res.send(<span class="hljs-string">'Hello, '</span> + req.user.username);
    res.send(<span class="hljs-string">'Hello, Stranger!'</span>);
});

<span class="hljs-comment">// specify a URL that only authenticated users can hit</span>
app.get(<span class="hljs-string">'/protected'</span>,
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
        <span class="hljs-keyword">if</span> (!req.user) <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">401</span>);
        res.send(<span class="hljs-string">'You have access.'</span>);
    }
);

<span class="hljs-comment">// specify the login url</span>
app.put(<span class="hljs-string">'/auth/login'</span>,
    passport.authenticate(<span class="hljs-string">'local'</span>),
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
        res.send(<span class="hljs-string">'You are authenticated, '</span> + req.user.username);
    });

<span class="hljs-comment">// log the user out</span>
app.put(<span class="hljs-string">'/auth/logout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    req.logout();
    res.send(<span class="hljs-string">'You have logged out.'</span>);
});

<span class="hljs-comment">// start the server listening</span>
app.listen(<span class="hljs-number">3000</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Server listening on port 3000.'</span>);
});</code></pre>
<h2 id="code-break-down">Code Break Down</h2>
<p>This part of the code should look pretty familiar. We include the modules we plan to use and start up the express web server.</p>
<pre><code class="language-js"><span class="hljs-comment">// include modules</span>
<span class="hljs-keyword">const</span> bodyParser        = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>);
<span class="hljs-keyword">const</span> cookieParser      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-parser'</span>);
<span class="hljs-keyword">const</span> express           = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> LocalStrategy     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport-local'</span>).Strategy;
<span class="hljs-keyword">const</span> passport          = <span class="hljs-built_in">require</span>(<span class="hljs-string">'passport'</span>);
<span class="hljs-keyword">const</span> session           = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);

<span class="hljs-comment">// initialize express app</span>
<span class="hljs-keyword">const</span> app = express();

...

<span class="hljs-comment">// start the server listening</span>
app.listen(<span class="hljs-number">3000</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Server listening on port 3000.'</span>);
});</code></pre>
<p>Here we tell express what middleware to use:</p>
<ul>
<li>The body-parser will extract body information from the request and store it at req.body for each request.</li>
<li>The cookie-parser will determine what cookies the client has on it and store it at req.cookie.</li>
<li>The express-session works with cookies to create and maintain session information.</li>
<li>The passport.initialize() is required to initialize passport.</li>
<li>The passport.session() must be added at some point <strong>after</strong> express-session middleware. It augments express-sessions by adding authentication information to the session.</li>
</ul>
<pre><code class="language-js">...

<span class="hljs-comment">// tell the express app what middleware to use</span>
app.use(bodyParser.urlencoded({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));
app.use(cookieParser());
app.use(session({ <span class="hljs-attr">secret</span>: <span class="hljs-string">'secret key'</span>, <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">true</span> }));
app.use(passport.initialize());
app.use(passport.session());

...</code></pre>
<p>This code tells passport of an authentication strategy that we will use.</p>
<ul>
<li>It is possible to have more than one strategy.</li>
<li>The local strategy expects two parameters to be sent with the request, <em>username</em> and <em>password</em>.</li>
<li>It is possible to change the names of those parameters through the local strategy configuration.</li>
<li>The done function must be called after you are done checking the username and password.<ul>
<li>If there was an error then the first parameter of <code>done</code> will be that error.</li>
<li>If there is no error then the first parameters should be null and the second can be the user object or false on failed authentication.</li>
</ul>
</li>
</ul>
<pre><code class="language-js">...

<span class="hljs-comment">// tell passport to use a local strategy and tell it how to validate a username and password</span>
passport.use(<span class="hljs-keyword">new</span> LocalStrategy(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">username, password, done</span>) </span>{
    <span class="hljs-keyword">if</span> (username &amp;&amp; password === <span class="hljs-string">'pass'</span>) <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, { <span class="hljs-attr">username</span>: username });
    <span class="hljs-keyword">return</span> done(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
}));

...</code></pre>
<ul>
<li>With session management, when a user authenticates, the user object from <code>done</code> can be serialized into a string.</li>
<li>The deserialize function is used to turn the string back into the user object. This function is called when a request is made and the user is already authenticated.</li>
</ul>
<pre><code class="language-js">...

<span class="hljs-comment">// tell passport how to turn a user into serialized data that will be stored with the session</span>
passport.serializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user, done</span>) </span>{
    done(<span class="hljs-literal">null</span>, user.username);
});

<span class="hljs-comment">// tell passport how to go from the serialized data back to the user</span>
passport.deserializeUser(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id, done</span>) </span>{
    done(<span class="hljs-literal">null</span>, { <span class="hljs-attr">username</span>: id });
});

...</code></pre>
<p>Here we set up routes. If the req parameter has a <code>user</code> property then the user is authenticated.</p>
<pre><code class="language-js">...

<span class="hljs-comment">// home page</span>
app.get(<span class="hljs-string">'/'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>{
    <span class="hljs-keyword">if</span> (req.user) <span class="hljs-keyword">return</span> res.send(<span class="hljs-string">'Hello, '</span> + req.user.username);
    res.send(<span class="hljs-string">'Hello, Stranger!'</span>);
});

<span class="hljs-comment">// specify a URL that only authenticated users can hit</span>
app.get(<span class="hljs-string">'/protected'</span>,
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
        <span class="hljs-keyword">if</span> (!req.user) <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">401</span>);
        res.send(<span class="hljs-string">'You have access.'</span>);
    }
);

<span class="hljs-comment">// specify the login url</span>
app.put(<span class="hljs-string">'/auth'</span>,
    passport.authenticate(<span class="hljs-string">'local'</span>),
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
        res.send(<span class="hljs-string">'You are authenticated, '</span> + req.user.username);
    });

<span class="hljs-comment">// log the user out</span>
app.delete(<span class="hljs-string">'/auth'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    req.logout();
    res.send(<span class="hljs-string">'You have logged out.'</span>);
});

...</code></pre>
<h2 id="deeper-understanding">Deeper Understanding</h2>
<p>To better understand how these components work together:</p>
<ul>
<li>Clone the git repository at <a href="https://github.com/Gi60s/it410-resources">https://github.com/Gi60s/it410-resources</a></li>
<li>Open in your IDE the <code>it410-resources/sessions/index.js</code></li>
<li>Do an <code>npm install</code> on the directory</li>
<li>Run this <code>index.js</code> code in debug mode.</li>
<li>Set up breakpoints for the different route callbacks as well as on the LocalStrategy and the serialize/deserialize methods.</li>
<li>Make GET, PUT, and DELETE requests (using Postman) to the various endpoints.</li>
</ul>
<h2 id="storing-sessions-in-the-database">Storing Sessions in the Database</h2>
<p>Usually you want to tie your session to your database. This is critical if your server is load balanced or needs restarting without killing existing sessions.</p>
<ul>
<li><a href="https://www.npmjs.com/package/express-mongo-session">express-mongo-session</a></li>
<li><a href="https://www.npmjs.com/package/express-mysql-session">express-mysql-session</a></li>
</ul>
</div>
      </article>

      <footer class="site-footer">

        
        <p>
          Caught a mistake or want to contribute to the documentation?
          <a href="https://github.com/Gi60s/full-stack-dev/tree/master/docs-src/session-management.md" target="_blank" rel="noopener">Edit this page on Github</a>
        </p>
        

        

        
        <div class="footer-links">
          
        </div>
        

      </footer>
    </div>

  </div>
</div>

<script src="/full-stack-dev/template-files/js/main.js"></script>


<script src="/full-stack-dev/js/main.js"></script>



</body>

</html>
